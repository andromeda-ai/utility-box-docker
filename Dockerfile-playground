# Use NVIDIA's CUDA base image for better GPU support
FROM nvidia/cuda:11.8.0-cudnn8-devel-ubuntu22.04

# Set environment variables
ENV DEBIAN_FRONTEND=noninteractive
ENV PATH="/usr/local/cuda/bin:${PATH}"
ENV LD_LIBRARY_PATH="/usr/local/cuda/lib64:${LD_LIBRARY_PATH}"

# Install system utilities and dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    git \
    htop \
    iotop \
    ncdu \
    openssh-server \
    python3-pip \
    rsync \
    screen \
    sysstat \
    tmux \
    wget \
    zsh \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Install NVIDIA NCCL
RUN apt-get update && apt-get install -y --no-install-recommends \
    libnccl2=2.14.3-1+cuda11.8 \
    libnccl-dev=2.14.3-1+cuda11.8 \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Install Google Cloud SDK
RUN echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] http://packages.cloud.google.com/apt cloud-sdk main" | tee -a /etc/apt/sources.list.d/google-cloud-sdk.list \
    && curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key --keyring /usr/share/keyrings/cloud.google.gpg add - \
    && apt-get update && apt-get install -y google-cloud-cli \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Install Azure CLI
RUN curl -sL https://aka.ms/InstallAzureCLIDeb | bash

# Install Python libraries and ML tools
RUN pip3 install --no-cache-dir --upgrade pip \
    && pip3 install --no-cache-dir \
    numpy \
    pandas \
    scikit-learn \
    scipy \
    matplotlib \
    seaborn \
    jupyter \
    jupyterlab \
    tensorflow \
    torch \
    torchvision \
    torchaudio \
    transformers \
    datasets \
    opencv-python-headless \
    horovod \
    mlflow \
    wandb \
    ray[tune] \
    optuna

# Install additional GPU tools
RUN pip3 install --no-cache-dir \
    nvitop \
    py3nvml \
    pynvml

# Install benchmarking tools
RUN pip3 install --no-cache-dir \
    pytest-benchmark \
    memory_profiler \
    line_profiler

# Setup SSH
RUN mkdir /var/run/sshd
RUN echo 'root:root' | chpasswd
RUN sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config

# Expose SSH port
EXPOSE 22

# Add startup script
COPY startup_script.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/startup_script.sh

# Set the entrypoint
ENTRYPOINT ["/usr/local/bin/startup_script.sh"]
